<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>Test â€“ KaÄenka</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: Arial, sans-serif; margin: 20px; max-width: 900px; }
.hidden { display: none; }
.login-box { max-width: 400px; margin: auto; padding: 20px; border: 1px solid #ccc; border-radius: 10px; }
input { width: 100%; padding: 8px; margin: 6px 0; }
button { padding: 8px 12px; margin: 5px; border: none; border-radius: 6px; background: #007bff; color: white; cursor: pointer; }
button.danger { background: #d9534f; }
button.neutral { background: #6c757d; }
.question { padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin: 10px 0; }
.answers { display: flex; flex-direction: column; gap: 6px; }
.answer-btn { padding: 8px; border-radius: 6px; border: 1px solid #333; background: white; cursor: pointer; text-align: left; }
.answer-btn.correct { background: #28a745; color: white; }
.answer-btn.wrong { background: #dc3545; color: white; }
.topbar { display: flex; justify-content: space-between; align-items: center; }
.status.online { color: blue; }
.status.offline { color: gray; }
.result-item { padding: 8px; border-bottom: 1px solid #ccc; }
</style>
</head>

<body>
<h1>InteraktivnÃ­ test â€“ KaÄenka</h1>

<!-- ================== LOGIN ================== -->
<div id="login" class="login-box">
  <h2>PÅ™ihlÃ¡Å¡enÃ­</h2>
  <label>JmÃ©no:</label>
  <input id="username" type="text">
  <label>Heslo:</label>
  <input id="password" type="password">
  <button id="loginBtn">PÅ™ihlÃ¡sit</button>
  <p style="font-size: 12px; color: gray;">
    ÃšÄty: KaÄenka / Kacenka55dg5<br>
    RodiÄ / domkac23
  </p>
</div>

<!-- ================== STUDENT VIEW ================== -->
<div id="studentView" class="hidden">
  <div class="topbar">
    <div><b id="studentName"></b> â€¢ <span id="studentStatus" class="status online">dÄ›lÃ¡ test</span></div>
    <button id="exitStudent" class="neutral">Exit</button>
  </div>

  <h2>Test</h2>
  <div id="questions"></div>

  <button id="submitAnswers">Poslat odpovÄ›di</button>
  <button id="resetAnswers" class="neutral">Resetovat test</button>

  <p id="studentMsg"></p>
</div>

<!-- ================== PARENT VIEW ================== -->
<div id="parentView" class="hidden">
  <div class="topbar">
    <b>RodiÄ</b>
    <button id="exitParent" class="neutral">Exit</button>
  </div>

  <h2>Menu</h2>
  <button id="showTestStructure">Jak vypadÃ¡ test?</button>
  <button id="showKacenkaResults">VÃ½sledky KaÄenky</button>

  <div id="parentArea"></div>
</div>

<!-- ================== FIREBASE ================== -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

<script>
/* ==========================================================
   ğŸ”¥ 1) DOPLÅ‡ SI SVÅ®J FIREBASE CONFIG !!!
   ========================================================== */
const firebaseConfig = {
  apiKey: "DOPLNIT",
  authDomain: "DOPLNIT",
  projectId: "DOPLNIT",
  storageBucket: "DOPLNIT",
  messagingSenderId: "DOPLNIT",
  appId: "DOPLNIT"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ==========================================================
   OtÃ¡zky
   ========================================================== */
const QUESTIONS = [
  {
    id: 1,
    text: "Vyber sprÃ¡vnou skupinu obilÃ­",
    correct: "a",
    options: {
      a: "PÅ¡enice, JeÄmen, Oves, Å½ito",
      b: "HrÃ¡ch, Fazole, ÄŒoÄka",
      c: "PÅ¡enice, JeÄmen, HrÃ¡ch, ÄŒoÄka"
    }
  },
  {
    id: 2,
    text: "Vyber sprÃ¡vnou skupinu luÅ¡tÄ›nin",
    correct: "b",
    options: {
      a: "HrÃ¡ch, KoÄka, Fazole",
      b: "HrÃ¡ch, ÄŒoÄka, Fazole",
      c: "Å½ito, JeÄmen, ÄŒoÄka"
    }
  },
  {
    id: 3,
    text: "Z Äeho se sklÃ¡dÃ¡ obilÃ­?",
    correct: "a",
    options: {
      a: "Zrno, Klas, StÃ©blo, KoÅ™en",
      b: "List, Zrno, StÃ©blo, KoÅ™en",
      c: "KoÅ™en, Stonek, List"
    }
  },
  {
    id: 4,
    text: "Co mohou bÃ½t takÃ© zemÄ›dÄ›lskÃ© plodiny?",
    correct: "c",
    options: {
      a: "Brambory, Å˜epa, Jahoda, SluneÄnice",
      b: "Brambory, Å˜epa, KukuÅ™ice, Brambory",
      c: "Brambory, Å˜epa, KukuÅ™ice, SluneÄnice"
    }
  },
  {
    id: 5,
    text: "RozdÃ­l mezi sÃ¡zenÃ­m a setÃ­m",
    correct: "a",
    options: {
      a: "Seje se semeno, SÃ¡zÃ­ se rostlinka",
      b: "Seje se rostlinka, SÃ¡zÃ­ se semeno"
    }
  }
];

/* ==========================================================
   Login
   ========================================================== */
let currentUser = null;

document.getElementById("loginBtn").onclick = async () => {
  const u = username.value.trim();
  const p = password.value;

  const users = db.collection("users");
  const q = await users.where("username","==",u).where("password","==",p).get();

  if (q.empty) { alert("Å patnÃ© jmÃ©no nebo heslo"); return; }

  const doc = q.docs[0];
  currentUser = { id: doc.id, ...doc.data() };

  login.classList.add("hidden");

  if (currentUser.role === "student") {
    showStudent();
  } else {
    showParent();
  }
};

/* ==========================================================
   Student view
   ========================================================== */
let answers = {};

function showStudent(){
  studentName.textContent = currentUser.username;
  studentView.classList.remove("hidden");

  renderQuestions();

  db.collection("users").doc(currentUser.id).update({status:"online"});
}

function renderQuestions(){
  questions.innerHTML = "";

  QUESTIONS.forEach(q=>{
    const div = document.createElement("div");
    div.className = "question";
    div.innerHTML = `<b>${q.id}. ${q.text}</b>`;

    const wrap = document.createElement("div");
    wrap.className = "answers";

    for (let key in q.options){
      const btn = document.createElement("button");
      btn.className = "answer-btn";
      btn.textContent = q.options[key];

      btn.onclick = () => {
        answers[q.id] = key;

        // zbarvenÃ­
        [...wrap.children].forEach(b=>b.classList.remove("correct","wrong"));
        if (key === q.correct) btn.classList.add("correct");
        else {
          btn.classList.add("wrong");
          const correctBtn = [...wrap.children].find(b=>b.textContent===q.options[q.correct]);
          if(correctBtn) correctBtn.classList.add("correct");
        }
      };

      wrap.appendChild(btn);
    }

    div.appendChild(wrap);
    questions.appendChild(div);
  });
}

submitAnswers.onclick = async () => {
  let correct = 0;
  QUESTIONS.forEach(q=>{
    if (answers[q.id] === q.correct) correct++;
  });

  await db.collection("tests").add({
    userId: currentUser.id,
    userName: currentUser.username,
    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
    answers,
    correct,
    wrong: QUESTIONS.length - correct
  });

  db.collection("users").doc(currentUser.id).update({status:"offline"});

  studentMsg.textContent = "OdpovÄ›di odeslÃ¡ny!";
};

resetAnswers.onclick = () => {
  answers = {};
  renderQuestions();
};

exitStudent.onclick = () => location.reload();

/* ==========================================================
   Parent view
   ========================================================== */
function showParent(){
  parentView.classList.remove("hidden");
}

/* Test struktura */
showTestStructure.onclick = () => {
  parentArea.innerHTML = "<h3>Struktura testu</h3>";

  QUESTIONS.forEach(q=>{
    const d = document.createElement("div");
    d.className = "question";
    d.innerHTML = `<b>${q.id}. ${q.text}</b><br>`;

    for(let key in q.options){
      const item = document.createElement("div");
      item.textContent = `${key}) ${q.options[key]}`;
      if (key === q.correct) item.style.color = "green";
      parentArea.appendChild(d);
      d.appendChild(item);
    }
  });
};

/* VÃ½sledky KaÄenky */
showKacenkaResults.onclick = async () => {
  parentArea.innerHTML = "<h3>VÃ½sledky KaÄenky</h3>";

  const userQ = await db.collection("users")
    .where("username","==","KaÄenka")
    .get();

  if (userQ.empty){
    parentArea.innerHTML += "<p>ÃšÄet KaÄenka nenalezen.</p>";
    return;
  }

  const userId = userQ.docs[0].id;
  const tests = await db.collection("tests")
    .where("userId","==",userId)
    .orderBy("timestamp","desc")
    .get();

  const status = userQ.docs[0].data().status;
  parentArea.innerHTML += `<p>Status: <b style="color:${status==="online"?"blue":"gray"}">${status==="online"?"KaÄenka dÄ›lÃ¡ test":"KaÄenka je offline"}</b></p>`;

  tests.forEach(t=>{
    const data = t.data();
    const d = document.createElement("div");
    d.className = "result-item";
    d.innerHTML = `
      <b>${new Date(data.timestamp?.toDate()).toLocaleString()}</b><br>
      SprÃ¡vnÄ›: ${data.correct}/5 â€¢ Å patnÄ›: ${data.wrong}/5<br>
      <button class="neutral" onclick="showTestDetail('${t.id}')">PodÃ­vat se na jejÃ­ test</button>
    `;
    parentArea.appendChild(d);
  });
};

/* Detail testu */
async function showTestDetail(id){
  const doc = await db.collection("tests").doc(id).get();
  const data = doc.data();

  parentArea.innerHTML = "<h3>Detail testu</h3>";

  QUESTIONS.forEach(q=>{
    const d = document.createElement("div");
    d.className = "question";
    d.innerHTML = `<b>${q.id}. ${q.text}</b>`;

    const wrap = document.createElement("div");
    wrap.className = "answers";

    for (let key in q.options){
      const btn = document.createElement("div");
      btn.className = "answer-btn";
      btn.textContent = q.options[key];

      if (data.answers[q.id] === key && key === q.correct)
        btn.classList.add("correct");
      else if (data.answers[q.id] === key && key !== q.correct)
        btn.classList.add("wrong");

      wrap.appendChild(btn);
    }

    d.appendChild(wrap);
    parentArea.appendChild(d);
  });
}

exitParent.onclick = () => location.reload();

</script>

</body>
</html>
